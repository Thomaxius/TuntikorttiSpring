<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Workdaylist</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link type="text/css" rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    
</head>
<body>
	<h1>Workdays</h1>
		<div class="col-md-4" style="padding:20px 0">
		<form th:action="@{/logout}" method="post">
			<input type="submit" value="Sign Out" class="btn btn-danger"/>
		</form>
	</div>

						

			
			
	<h3 th:inline="text">Welcome, [[${#httpServletRequest.remoteUser}]]</h3>
    <table id="workdaysTable" class="table table-striped">
		<tr>
		    <th>Työvuoron alku</th>
		    <th>Työvuoron loppu</th>
		    <th>Tunnit yhteensä</th>
		    <th>Auto</th>
		    <th>Paulig</th>
		    <th>Fazer</th>
   		    <th>Merca</th>
 		    <th>Pahvit</th>
		    <th>Akaa</th>
   		    <th>Kesko</th>
   		    <th>Muut määrä</th>
   		    <th>Muut selitys</th>
  		    <th sec:authorize="hasAuthority('ADMIN')"></th> 
  		    <th sec:authorize="hasAuthority('ADMIN')"></th>  		    
		</tr>  
    	<tr th:each = "workday : ${workdays}">
    		<td th:text="${#dates.format(workday.beginDate, 'dd.MM.yyyy HH:mm')}"></td>
    		<td th:text="${#dates.format(workday.endDate, 'dd.MM.yyyy HH:mm')}"></td>
    		<td id="hourColumn" class="hourColumn" th:text="${T(hh.palvelinohjelmointi.domain.UtilityClass).getDifferenceInHours(workday.beginDate, workday.endDate)}"></td>
       		<td th:text="${workday.vehicle.regNo}"></td>
    		<td th:text="${workday.pauligAmount}"></td>
    		<td th:text="${workday.fazerAmount}"></td>
    		<td th:text="${workday.mercaAmount}"></td>
    		<td th:text="${workday.pahvitAmount}"></td>
 		    <td th:text="${workday.akaaAmount}"></td>
 		    <td th:text="${workday.keskoAmount}"></td>
 		    <td th:text="${workday.otherAmount}"></td>
 		    <td th:text="${workday.otherInfo}"></td>
 			<td sec:authorize="hasAuthority('ADMIN')"><a class="btn btn-danger" th:href="@{/delete/{id}(id=${workday.id})}">Delete</a></td>
 			<td sec:authorize="hasAuthority('ADMIN')"><a th:href="@{/edit/{id}(id=${workday.id})}">Edit</a></td>    	
    	</tr>
    	<tr id="totalRow">
    	
    	<td></td>
    	<th>Yhteensä:</th>
    	<th id="totalHourCell"></th>
    	<th></th>
    	<th id="totalPauligCell"></th>
    	<th id="totalFazerCell"></th>
    	<th id="totalMercaCell"></th>
    	<th id="totalPahvitCell"></th>
     	<th id="totalAkaaCell"></th>
    	<th id="totalKeskoCell"></th>
    	<th id="totalOtherCell"></th>
     	<td></td>
    	<td></td>
    	<td></td>
    	<td></td>    	   	
    	</tr>

     </table>
     
     			<script th:inline="javascript">
     			
			function getTotals( obj ) { // Laskeekaikkien päivien työtehtävät yhteen
				let sum = 0;
				let tds = document.getElementById("workdaysTable").getElementsByClassName('hourColumn');
				for(let i=0;i<tds.length;i++){
					sum += isNaN(tds[i].innerText) ? 0 : parseFloat(tds[i].innerText);
				}
				return {
					totalHours: sum,
					totalPaulig: obj.reduce((acc, val) => acc + val.pauligAmount, 0),
					totalFazer: obj.reduce((acc, val) => acc + val.fazerAmount, 0),
					totalMerca: obj.reduce((acc, val) => acc + val.mercaAmount, 0), 
					totalPahvit: obj.reduce((acc, val) => acc + val.pahvitAmount, 0), 
					totalAkaa: obj.reduce((acc, val) => acc + val.akaaAmount, 0), 
					totalKesko: obj.reduce((acc, val) => acc + val.keskoAmount, 0), 
					totalOther: obj.reduce((acc, val) => acc + val.otherAmount, 0), 	
				}
			}
			
			function addTableRow(tableName, obj) { // Lisää tauluun viimeisen rivin, joka näyttää koko kuukauden kaikki työtehtävät ja tunnit summattuna
				let rows = document.getElementById(tableName).rows
				let row = rows.namedItem("totalRow")
				row.cells.namedItem("totalHourCell").innerHTML = obj.totalHours + 'h'
				row.cells.namedItem("totalPauligCell").innerHTML = obj.totalPaulig
				row.cells.namedItem("totalFazerCell").innerHTML = obj.totalFazer
				row.cells.namedItem("totalMercaCell").innerHTML = obj.totalMerca
				row.cells.namedItem("totalPahvitCell").innerHTML = obj.totalPahvit
				row.cells.namedItem("totalAkaaCell").innerHTML = obj.totalAkaa
				row.cells.namedItem("totalKeskoCell").innerHTML = obj.totalKesko
				row.cells.namedItem("totalOtherCell").innerHTML = obj.totalOther
				
			}
			
			const totalObj = getTotals([[${workdays}]])
			addTableRow("workdaysTable", totalObj	)
			</script>
	 <a href="/addworkday" class="btn btn-success">Add Workday</a>    	
</body>
</html>